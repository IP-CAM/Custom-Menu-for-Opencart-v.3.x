{{ header }}
<style>
  .menu-block .btn {
    margin: 2px;
  }
  .menu-item-btn {
    padding: 6px 40px;
    background-color: #4DD9FF;
    color: white;
    border: none;
    font-size: 16px;
    white-space: nowrap;
  }
  .menu-list {
    list-style-type: none;
    padding: 0;
    font-size: 15px;
  }
  .menu-list-item {
    padding: 3px;
    padding-left: 15px;
    border-radius: 3px;
    border: 2px solid #d9d9d9;
    margin-bottom: 5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .menu-list-item__inner {

  }
  .menu-list-item div {
    min-width: fit-content;
  }
  .menu-item-inner-block {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    border: 1px solid #e3e3e3;
    margin-bottom: 10px;
  }
  .menu-item-inner-block button {
    margin: 15px;
    padding: 6px;
    width: 80%;
  }
  .select-link-item, .add-edit-menu-item, .add-edit-module-item, .added-menu-item-menu, .added-menu-item-module {
    padding: 5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
  }
  .inner-blocks-placeholder {
    display: flex;
    justify-content: center;
    margin-top: 50px;
    font-size: 16px;
  }
</style>
{{ column_left }}

{% macro list(items, step = 0) %}
  {% import _self as tree %}

    {% for item in items %}
      <li class="menu-list-item" style="margin-left: {{ step * 25 }}px;">
        <span class="menu-list-item__inner">{{ item.name }}</span>
        <div>
          <button type="button" data-menu-item-id="{{ item.id }}" class="btn btn-primary edit-menu-item"><i class="fa fa-pencil"></i></button>
          <button type="button" data-menu-item-id="{{ item.id }}" class="btn btn-danger delete-menu-item"><i class="fa fa-trash"></i></button>
        </div>
        {% if item.children %}
          {{ tree.list(item.children, step + 1) }}
        {% endif %}
      </li>
    {% endfor %}
{% endmacro %}

{% macro category_list(items, step = 0) %}
  {% import _self as tree %}

  {% for item in items %}
    <div class="select-link-item" data-category-id="{{ item.id }}">
      <span style="margin-left: {{ step * 30 }}px;">{{ item.name }}</span>
      <input type="hidden" value="{{ item.link }}">
      <button class="btn btn-primary"><i class="fa fa-plus"></i></button>
    </div>
    {% if item.children %}
      {{ tree.category_list(item.children, step + 1) }}
    {% endif %}
  {% endfor %}
{% endmacro %}

<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="pull-right">
        <button type="submit" form="form-module" data-toggle="tooltip" title="{{ button_save }}" class="btn btn-primary"><i class="fa fa-save"></i></button>
        <a href="{{ cancel }}" data-toggle="tooltip" title="{{ button_cancel }}" class="btn btn-default"><i class="fa fa-reply"></i></a></div>
      <h1>{{ heading_title }}</h1>
      <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
        <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>
  <div class="container-fluid">
    {% if error_warning %}
    <div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}
      <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
    {% endif %}
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title"><i class="fa fa-pencil"></i> {{ text_edit }}</h3>
      </div>
      <div class="panel-body">
        <form action="{{ action }}" method="post" enctype="multipart/form-data" id="form-module" class="form-horizontal">
          <div class="form-group">
            <label class="col-sm-2 control-label" for="input-name">{{ entry_name }}</label>
            <div class="col-sm-10">
              <input type="text" name="name" value="{{ name }}" placeholder="{{ entry_name }}" id="input-name" class="form-control" />
              {% if error_name %}
              <div class="text-danger">{{ error_name }}</div>
              {% endif %}
            </div>
          </div>
          <div class="form-group">
            <div class="col-sm-3">
              <div class="menu-block">
                <button type="button" id="create-menu-item" class="menu-item-btn">Создать пункт меню</button>
                <ul class="menu-list">
                  {{ _self.list(menu_items) }}
                </ul>
              </div>
            </div>
            <div class="col-sm-9 create-menu-form" style="display: none;">
              <div class="panel panel-default">
                <div class="panel-heading">
                  <h4 class="panel-title">Настройки пункта меню</h4>
                </div>
                <div class="panel-body">

                  <ul class="nav nav-tabs" id="language">
                    {% for language in languages %}
                      <li><a href="#language{{ language.language_id }}" data-toggle="tab"><img src="language/{{ language.code }}/{{ language.code }}.png" title="{{ language.name }}"/> {{ language.name }}</a></li>
                    {% endfor %}
                  </ul>
                  <div class="tab-content">
                    {% for language in languages %}
                      <div class="tab-pane" id="language{{ language.language_id }}">
                        <div class="form-group">
                          <label class="col-sm-2 control-label" for="input-menu_item_parent{{ language.language_id }}">{{ entry_parent_item }}</label>
                          <div class="col-sm-10">
                            <select name="menu_item[{{ language.language_id }}][parent_id]" id="input-menu_item_parent{{ language.language_id }}" class="form-control select_parent_id">
                              <option value="0">{{ text_no }}</option>
                              {% if select_items %}
                                {% for select_item in select_items %}
                                  <option value="{{ select_item.id }}">{{ select_item.name }}</option>
                                {% endfor %}
                              {% endif %}
                            </select>
                          </div>
                        </div>
                        <div class="form-group required">
                          <label class="col-sm-2 control-label" for="input-name{{ language.language_id }}">{{ entry_name_item }}</label>
                          <div class="col-sm-10">
                            <input type="text" name="menu_item[{{ language.language_id }}][name]" value="{{ menu_item[language.language_id] ? menu_item[language.language_id].name }}" placeholder="{{ entry_name_item }}" id="input-name{{ language.language_id }}" class="form-control"/>
                            {% if error_name[language.language_id] %}
                              <div class="text-danger">{{ error_name[language.language_id] }}</div>
                            {% endif %}
                          </div>
                        </div>
                        <div class="form-group">
                          <label class="col-sm-2 control-label" for="input-menu-item-link{{ language.language_id }}">{{ entry_link }}</label>
                          <div class="col-sm-7">
                            <input type="text" name="menu_item[{{ language.language_id }}][link]" value="{{ menu_item[language.language_id] ? menu_item[language.language_id].link }}" placeholder="{{ entry_link }}" id="input-menu-item-link{{ language.language_id }}" class="form-control"/>
                            {% if error_meta_title[language.language_id] %}
                              <div class="text-danger">{{ error_meta_title[language.language_id] }}</div>
                            {% endif %}
                          </div>
                          <div class="col-sm-3">
                            <button type="button" class="menu-item-btn" data-toggle="modal" data-target=".select-link-modal">Выбрать адресс сылки</button>
                          </div>
                        </div>
                        <div class="form-group">
                          <label class="col-sm-2 control-label" for="input-menu-item-class{{ language.language_id }}">{{ entry_class_item }}</label>
                          <div class="col-sm-10">
                            <input type="text" name="menu_item[{{ language.language_id }}][class]" value="{{ menu_item[language.language_id] ? menu_item[language.language_id].class }}" placeholder="{{ entry_class_item }}" id="input-menu-item-class{{ language.language_id }}" class="form-control"/>
                            {% if error_meta_title[language.language_id] %}
                              <div class="text-danger">{{ error_meta_title[language.language_id] }}</div>
                            {% endif %}
                          </div>
                        </div>
                        <div class="form-group">
                          <label class="col-sm-2 control-label" for="input-meta-title{{ language.language_id }}">{{ entry_img_item }}</label>
                          <div class="col-sm-10">
                            <a href="" id="thumb-image{{ language.language_id }}" data-toggle="image" class="img-thumbnail">
                              <img src="{{ thumb }}" alt="" title="" data-placeholder="{{ placeholder }}"/>
                            </a>
                            <input type="hidden" name="menu_item[{{ language.language_id }}][image]" value="{{ image }}" id="input-image{{ language.language_id }}"/>
                          </div>
                        </div>


                          <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
                            <button class="menu-item-btn save-menu-item" id="save-menu-item-btn{{ language.language_id }}" type="button" form="menu-item-form">
                              {{ button_save }}
                            </button>
                          </div>

                        {% if menu_type != '1' %}

                          <div class="inner-blocks-placeholder" id="inner-blocks-placeholder{{ language.language_id }}">
                            Создайте пункт меню, чтобы добавить в него блоки
                          </div>

                          <div class="panel panel-default inner-blocks" id="inner-blocks-panel{{ language.language_id }}" style="display: none;">
                            <div class="panel-heading">
                              <h4 class="panel-title">Вложение пункта меню</h4>
                            </div>
                            <div class="panel-body">

                              <div class="tab-content">
                                {% for id in 1..8 %}
                                  <div class="col-sm-3">
                                    <div class="menu-item-inner-block" data-language-id="{{ language.language_id }}" data-block-id="{{ id }}">
                                      <button type="button" data-toggle="modal" data-target=".add-edit-menu-modal" class="menu-item-btn">{{ button_add_menu }}</button>
                                      <button type="button" data-toggle="modal" data-target=".add-edit-module-modal" class="menu-item-btn">{{ button_add_module }}</button>
                                    </div>
                                  </div>
                                {% endfor %}
                              </div>

                            </div>
                          </div>
                        {% endif %}

                      </div>
                      {% endfor %}
                    </div>

                </div>
              </div>

            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-2 control-label" for="input-status">{{ entry_status }}</label>
            <div class="col-sm-10">
              <select name="status" id="input-status" class="form-control">
                {% if status %}
                <option value="1" selected="selected">{{ text_enabled }}</option>
                <option value="0">{{ text_disabled }}</option>
                {% else %}
                <option value="1">{{ text_enabled }}</option>
                <option value="0" selected="selected">{{ text_disabled }}</option>
                {% endif %}
              </select>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade select-link-modal" tabindex="-1" role="dialog" aria-labelledby="selectLinkModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">Выбрать ссылку</h4>
          </div>
          <div class="panel-body">

            <ul class="nav nav-tabs" id="select-link-tabs">
              <li><a href="#select-link-categories" data-toggle="tab">Категории</a></li>
              <li><a href="#select-link-articles" data-toggle="tab">Статьи</a></li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane" id="select-link-categories">
                {{ _self.category_list(categories) }}
              </div>
              <div class="tab-pane" id="select-link-articles">
                {% for information in informations %}
                  <div class="select-link-item" data-article-id="{{ information.information_id }}">
                    <span>{{ information.title }}</span>
                    <input type="hidden" value="{{ information.link }}">
                    <button class="btn btn-primary"><i class="fa fa-plus"></i></button>
                  </div>
                {% endfor %}
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="modal fade add-edit-menu-modal" tabindex="-1" role="dialog" aria-labelledby="selectLinkModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">Добавить / Редактировать блок</h4>
          </div>
          <div class="panel-body">

            <div class="col-sm-8">
              <ul class="nav nav-tabs" id="add-edit-menu-tabs">
                <li><a href="#add-edit-block-articles" data-toggle="tab">Статьи</a></li>
                <li><a href="#add-edit-block-categories" data-toggle="tab">Категории</a></li>
                <li><a href="#add-edit-block-external-link" data-toggle="tab">Внешняя ссылка</a></li>
              </ul>
              <div class="tab-content">
                <div class="tab-pane" id="add-edit-block-articles">
                  {% for information in informations %}
                    <div class="add-edit-menu-item">
                      <span>{{ information.title }}</span>
                      <button class="btn btn-primary add-article-btn" data-article-id="{{ information.information_id }}"><i class="fa fa-plus"></i></button>
                    </div>
                  {% endfor %}
                </div>
                <div class="tab-pane" id="add-edit-block-categories">
                  {{ _self.category_list(categories) }}
                </div>
                <div class="tab-pane" id="add-edit-block-external-link">
                  <div class="form-group">
                    <label class="control-label" for="input-name">Введите название пункта меню</label>
                    <input type="text" name="name" value="" placeholder="Введите название пункта меню" id="input-menu-item-name" class="form-control" />
                  </div>
                  <div class="form-group">
                    <label class="control-label" for="input-name">Введите ссылку (данное поле можно не заполнять)</label>
                    <input type="text" name="name" value="" placeholder="Введите ссылку (данное поле можно не заполнять)" id="input-menu-item-link" class="form-control" />
                  </div>
                  <div style="display: flex; justify-content:center;">
                    <button type="button" class="menu-item-btn">Добавить пункт</button>
                  </div>
                </div>
              </div>
            </div>

            {# RIGHT SIDE ADD-EDIT-BLOCK POPUP #}
            <div class="col-sm-4">
              <div class="inner-block-added-content">
                <span>Добавлены в блок</span>
                <hr>
                <div class="form-group">
                  <input type="text" placeholder="Введите заголовок блока" name="added-in-block" class="form-control">
                </div>
                <div class="inner-block-added-content-list">
                  {% for number in 1..5 %}
                    <div class="added-menu-item-menu" data-item-id="{{ number }}">
                      <span>Punkt {{ number }}</span>
                      <button class="btn btn-danger"><i class="fa fa-trash"></i></button>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="modal fade add-edit-module-modal" tabindex="-1" role="dialog" aria-labelledby="selectLinkModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">Добавить / Редактировать блок</h4>
          </div>
          <div class="panel-body">

            <div class="col-sm-8">
              <ul class="nav nav-tabs" id="add-edit-module-tabs">
                <li><a href="#add-edit-module-list" data-toggle="tab">Модули</a></li>
              </ul>
              <div class="tab-content">
                <div class="tab-pane" id="add-edit-module-list">
                  {% for information in informations %}
                    <div class="add-edit-module-item">
                      <span>{{ information.title }}</span>
                      <button class="btn btn-primary" data-article-id="{{ information.information_id }}"><i class="fa fa-plus"></i></button>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>

            {# RIGHT SIDE ADD-EDIT-BLOCK POPUP #}
            <div class="col-sm-4">
              <div class="inner-block-added-content">
                <span>Добавлены в блок</span>
                <hr>
                <div class="form-group">
                  <input type="text" placeholder="Введите заголовок блока" name="added-in-block" class="form-control">
                </div>
                <div class="inner-block-added-content-list">
                  {% for number in 1..5 %}
                    <div class="added-menu-item-module" data-item-id="{{ number }}">
                      <span>Punkt {{ number }}</span>
                      <button class="btn btn-danger"><i class="fa fa-trash"></i></button>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <script type="text/javascript">
  $(document).ready(function () {
    $('.menu-item-inner-block button').on('click', function () {
      let saveBtn = $(this).parent().parent().parent().parent().parent().parent().find('.save-menu-item')
      let menuItemId = $(saveBtn).data('menu-item-id')
      let targetSelector = $(this).data('target')
      $(targetSelector).find('.btn').attr('data-menu-item-id', menuItemId)
    })

    $('.add-edit-menu-item .add-article-btn').on('click', function () {
        let menuItemId = $(this).data('menu-item-id')
        let blocksList = $(this).parent().parent().parent().parent().parent().find('.inner-block-added-content-list')
        $.ajax({
            type: "GET",
            url: "index.php?route=extension/module/custom_menu_nik/addMenuItemBlock&user_token={{ user_token }}&menu_item_id=" + menuItemId + "&article_id=" + $(this).data('article-id'),
            success: function (res) {
                getMenuItemBlocks(menuItemId, blocksList)
            }
        })
    })

    function getMenuItemBlocks(menuItemId, target) {
        $.ajax({
            type: "GET",
            url: "index.php?route=extension/module/custom_menu_nik/getMenuItemBlocks&user_token={{ user_token }}&menu_item_id=" + menuItemId,
            success: function (res) {
                $(target).html(HtmlMenuItemBlocks(res))
            }
        })
    }

    function HtmlMenuItemBlocks(blocks) {
        let html = '';
        for (let i = 0; i < blocks.length; i++) {
            html += '<div class="added-menu-item-menu" data-block-id="' + blocks[i].id +'">' +
                        '<span>' + blocks[i].name +'</span>' +
                        '<button class="btn btn-danger"><i class="fa fa-trash"></i></button>' +
                    '</div>'
        }
        return html;
    }

    deleteMenuItem();
    function deleteMenuItem() {
        $('.delete-menu-item').unbind('click');
        $('.delete-menu-item').on('click', function (e) {
            if(confirm('Вы уверены, что хотите удалить пункт меню?')) {
                $.ajax({
                    type: "POST",
                    url: "index.php?route=extension/module/custom_menu_nik/deleteMenuItem&user_token={{ user_token }}&menu_item_id=" + $(this).data('menu-item-id'),
                    success: function (res) {
                        getMenuItems()
                        getSelectItems()
                    }
                })
            }
        })
    }

    editMenuItem()
    function editMenuItem() {
        $('.edit-menu-item').unbind('click');
        $('.edit-menu-item').on('click', function (e) {
            $.ajax({
                type: "GET",
                url: "index.php?route=extension/module/custom_menu_nik/getMenuItem&user_token={{ user_token }}&menu_item_id=" + $(this).data('menu-item-id') + "&module_id={{ module_id }}",
                success: function (res) {
                    let html = selectList(res['menu_items']);
                    $('.select_parent_id').html(html)
                    let keys = Object.keys(res);
                    for (let i = 0; i < keys.length; i++) {
                        let el = $( ":input[name='menu_item[" + res['language_id'] + "][" + keys[i] + "]']" )
                        if(el.length) {
                            el.val(res[keys[i]])
                        }
                    }
                    $('#thumb-image' + res['language_id'] + ' img').attr('src', res['thumb'])
                    $('#save-menu-item-btn' + res['language_id']).data('menu-item-id', res['id'])
                    $('#inner-blocks-placeholder' + res['language_id']).hide()
                    $('#inner-blocks-panel' + res['language_id']).show()

                    $('.create-menu-form').show();
                }
            })
        })
    }

    $('.save-menu-item').on('click', function (e) {
        if(!$(this).data('menu-item-id')) { // add menu item
            $.ajax({
                type: "POST",
                dataType: 'html',
                data: $( ":input[name*='menu_item']" ).serialize(),
                url: 'index.php?route=extension/module/custom_menu_nik/addMenuItems&module_id={{ module_id }}&user_token={{ user_token }}',
                success: function (res) {
                    getMenuItems()
                    getSelectItems()
                    clearFields();
                    $('.create-menu-form').hide()
                }
            })
        } else { // edit menu item
            $.ajax({
                type: "POST",
                dataType: 'html',
                data: $( ":input[name*='menu_item']" ).serialize(),
                url: 'index.php?route=extension/module/custom_menu_nik/editMenuItem&user_token={{ user_token }}&menu_item_id=' + $(this).data('menu-item-id'),
                success: function (res) {
                    getMenuItems()
                    getSelectItems()
                    clearFields();
                    $('.create-menu-form').hide()
                }
            })
        }
    })

    function clearFields() {
        $( ":input[name*='menu_item']" ).each(function (i, item) {
            if($(item).is('select')) {
                $(item).find('option[value="0"]').prop('selected', true)
            } else {
                $(item).val('')
            }
        })
        // CLEARING IMG THUMB AFTER SAVING
        $('.img-thumbnail').each(function (i, item) {
            let imgThumb = $(item).find('img');
            let imgPlaceholder = imgThumb.data('placeholder')
            imgThumb.attr('src', imgPlaceholder)
        })
    }

    async function getSelectItems() {
        let html = '';
        $.ajax({
            type: "GET",
            url: "index.php?route=extension/module/custom_menu_nik/getSelectItems&module_id={{ module_id }}&user_token={{ user_token }}",
            success: function (res) {
                html = selectList(res);
                $('.select_parent_id').html(html)

            }
        })
    }

    function selectList(arr) {
        let html = '<option value="0">{{ text_no }}</option>';
        for(let i = 0; i < arr.length; i++) {
            html += '<option value="'+ arr[i].id +'">'+ arr[i].name +'</option>';
        }

        return html;
    }

    function getMenuItems() {
        let html = '';
        $.ajax({
            type: "GET",
            url: "index.php?route=extension/module/custom_menu_nik/getMenuItems&module_id={{ module_id }}&user_token={{ user_token }}",
            success: function (res) {
                html = menuList(res);
                $('.menu-list').html(html);
                deleteMenuItem()
                editMenuItem()
            }
        })
    }

    function menuList(arr, step = 0) {
        let branch = '';
        for(let i = 0; i < arr.length; i++) {
            branch += '<li class="menu-list-item" style="margin-left: ' + (step * 25) + 'px;">' +
                '<span class="menu-list-item__inner">' + arr[i].name + '</span>' +
                '<div>' +
                '<button type="button" data-menu-item-id="' + arr[i].id +'" class="btn btn-primary edit-menu-item"><i class="fa fa-pencil"></i></button>' +
                '<button type="button" data-menu-item-id="' + arr[i].id +'" class="btn btn-danger delete-menu-item"><i class="fa fa-trash"></i></button>' +
            '</div>';
            if(arr[i].children) {
              branch += menuList(arr[i].children, step + 1);
            }

            branch += '</li>';
        }
        return branch;
    }

    $('#create-menu-item').on('click', function () {
      getSelectItems()
      clearFields()
      $('.save-menu-item').each(function (i, item) {
        $(item).data('menu-item-id', false)
      })
      $('.inner-blocks').hide();
      $('.inner-blocks-placeholder').show();
      $('.create-menu-form').show();
    })

    $('.select-link-item button').on('click', function () {
      let link = $(this).prev().val();
      let activeTabId = '#language1';
      $('#language li').each(function (index, item) {
        if($(item).hasClass('active')) {
            activeTabId = $(item).find('a').attr('href')
        }
      })
      let languageId = activeTabId.slice(-1)
      $(activeTabId).find('#input-menu-item-link' + languageId).val(link)
      $('.select-link-modal').modal('hide')
    })
  })

  </script>
  <script type="text/javascript"><!--
      $('#add-edit-menu-tabs a:first').tab('show');
      $('#option a:first').tab('show');
  //--></script>
  <script type="text/javascript"><!--
      $('#add-edit-module-tabs a:first').tab('show');
      $('#option a:first').tab('show');
  //--></script>
  <script type="text/javascript"><!--
      $('#select-link-tabs a:first').tab('show');
      $('#option a:first').tab('show');
  //--></script>
  <script type="text/javascript"><!--
      $('#language a:first').tab('show');
      $('#option a:first').tab('show');
  //--></script>
</div>
{{ footer }}
